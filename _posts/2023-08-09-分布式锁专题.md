---
layout:     post
title:      åˆ†å¸ƒå¼é”
subtitle:   ç†Ÿæ‚‰åˆ†å¸ƒå¼é”çš„å„ç§åœºæ™¯
categories: [é›¶æ•£çŸ¥è¯†ç‚¹]
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---

# 1. ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ
ä»å•æœåŠ¡å™¨æ¶æ„å¼€å‘è¿‡æ¥çš„æœ‹å‹ä»¬åº”è¯¥éƒ½çŸ¥é“ï¼Œä½¿ç”¨javaå¼€å‘çš„æœåŠ¡éƒ¨ç½²åœ¨å•ä¸ªçš„tomcatæœåŠ¡å™¨ä¸Šï¼Œåˆ™æ•´ä¸ªåº”ç”¨ç¨‹åºéƒ½è¿è¡Œåœ¨åŒä¸€ä¸ªç‰©ç†æœºå™¨ä¸Šï¼Œå¹¶ä¸”æ•´ä¸ªåº”ç”¨ç¨‹åºå¯åŠ¨åï¼Œå…¶JVMä¹Ÿå§‹ç»ˆåœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œã€‚å› æ­¤ï¼Œè¿™ç§å•ä½“æ¶æ„ï¼Œæˆ‘ä»¬æ˜¯ä¸éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”çš„ã€‚    
å¯¹äºè¿™ç§å•ä½“æ¶æ„ï¼Œç›´æ¥ä½¿ç”¨JVMå†…éƒ¨çš„javaçº¿ç¨‹é”å³å¯ï¼Œå³Synchronizedæˆ–è€…Lockç­‰ä¸€äº›åŸºäºJVMå†…å­˜è®¾è®¡çš„å•åº”ç”¨é”å³å¯ã€‚    
åº”ç”¨ç¨‹åºä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨é”ï¼Ÿå…¶åŸå› è¿˜æ˜¯ä¸ºäº†é˜²æ­¢åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸´ç•Œèµ„æºçš„å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å®‰å…¨æ€§é—®é¢˜ã€‚åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œç›´æ¥ä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘ç­–ç•¥æ¯”å¦‚Synchronizedã€ThreadLocalç­‰æ“ä½œå³å¯å¯¹ä¸´ç•Œèµ„æºåšçº¿ç¨‹å®‰å…¨ä¿è¯ã€‚   
ä½†æ˜¯ï¼Œç›®å‰çš„æœåŠ¡éƒ¨ç½²æ¶æ„éƒ½æ˜¯å¤šèŠ‚ç‚¹å¤špodéƒ¨ç½²ï¼Œå³åŒä¸€ä¸ªåº”ç”¨æœåŠ¡ä¼šåŒæ—¶éƒ¨ç½²åœ¨å¤šä¸ªç‰©ç†æœºå™¨èŠ‚ç‚¹ä¸Šï¼Œè¿™ä¸ªä¸€æ¥ï¼Œæ•´ä¸ªå¾®æœåŠ¡ä½“ç³»æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé›†ç¾¤éƒ¨ç½²æ¨¡å¼äº†ã€‚     
åœ¨é›†ç¾¤éƒ¨ç½²æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªpodéƒ½éƒ¨ç½²ç›¸åŒçš„ä»£ç ï¼Œé‚£ä¹ˆæ„å‘³ç€å¤šä¸ªpodéƒ½ä¼šè¿è¡Œå„è‡ªçš„JVMï¼Œæ­¤æ—¶ï¼Œå½“å®¢æˆ·ç«¯å¹¶å‘è®¿é—®åŒä¸€ä¸ªä¸šåŠ¡èµ„æºæ—¶ï¼Œå•ä¸ªJVMçš„å•ä½“é”å°±åªèƒ½ä¿è¯å½“å‰èŠ‚ç‚¹çš„ä¸´ç•Œèµ„æºå®‰å…¨æ€§äº†ã€‚å¯¹äºå¤šä¸ªpodéƒ½éœ€è¦åŒæ—¶æ“ä½œä¸‰æ–¹å…±äº«çš„ä¸´ç•Œèµ„æºæ¯”å¦‚redisã€æ•°æ®åº“ç­‰æ—¶ï¼Œæ­¤æ—¶å•ä¸ªJVMçš„å•ä½“é”å°±æ²¡æ³•å®ç°å¹¶å‘ç¯å¢ƒä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚   
å› æ­¤ï¼Œè¦ä¿è¯**åœ¨åˆ†å¸ƒå¼å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªpodèŠ‚ç‚¹çš„å…±äº«ä¸´ç•Œèµ„æºçš„çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æœºåˆ¶**ã€‚    
è¦å®ç°åˆ†å¸ƒå¼é”ï¼Œè‚¯å®šéœ€è¦å€ŸåŠ©å…¬å…±çš„ä¸‰æ–¹ç»„ä»¶å»å®ç°ï¼Œè€Œä¸èƒ½ä¾èµ–JVMã€‚å³éœ€è¦ä¸€ä¸ªä¸‰æ–¹ç»„ä»¶ï¼Œæ¥ç®¡ç†åˆ†å¸ƒå¼éƒ¨ç½²çš„å¤šä¸ªåº”ç”¨èŠ‚ç‚¹ä¹‹å‰çš„å…±äº«é”é—®é¢˜ã€‚   

# 2.ä¸šç•Œå®ç°åˆ†å¸ƒå¼é”çš„æ–¹å¼
ç›®å‰æ¥çœ‹ï¼Œåœ¨java å¾®æœåŠ¡ç”Ÿæ€ä¸­ï¼Œå®ç°åˆ†å¸ƒå¼é”çš„å¸¸è§æ–¹å¼æ˜¯ï¼š    
1.ä½¿ç”¨redisæ¥å®ç°ã€‚   
2.ä½¿ç”¨zookeeperæ¥å®ç°ã€‚   

å…¶ä¸­ï¼Œä½¿ç”¨redisæ¥å®ç°çš„è¯ï¼Œå…·ä½“åˆåˆ’åˆ†ä¸ºåŸºæœ¬çš„redisçš„setNxå‘½ä»¤æ¥å®ç°ï¼›å’Œç›®å‰æ›´å…ˆè¿›çš„redissonæ¥å®ç°ã€‚   
æˆ‘ä»¬åªåˆ†æä½¿ç”¨redisæ¥å®ç°åˆ†ä¸é”çš„å„ç§æ–¹å¼ã€‚   

# 3.rediså®ç°åˆ†å¸ƒå¼é”çš„æ–¹å¼

# 4.redissonå®ç°åˆ†å¸ƒå¼é”çš„æ–¹å¼

# 5.redissonå®ç°å¤šé”
æˆ‘ä»¬ç›´æ¥ä»¥â€œåŒé”â€ä½œä¸ºä¸€ç§ç‰¹æ®Šå¤šé”æ¥è¿›è¡Œåˆ†æã€‚   
åŒé”çš„å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š   
â€œ**RedissonåŒé”**â€è®¾è®¡ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€ä¸ªéå¸¸å¸¸è§ä½†å®¹æ˜“å‡ºé”™çš„é«˜çº§åœºæ™¯ã€‚ä¸‹é¢æˆ‘ä¼šä»è®¾è®¡åŸåˆ™ â†’ å…¸å‹ç¤ºä¾‹ â†’ æ­»é”æˆå›  â†’ å®Œå…¨è§„é¿æ–¹æ¡ˆï¼Œé€æ­¥è®²æ¸…æ¥šã€‚

---

## ğŸ§© 5.1ã€åŒé”çš„å…¸å‹ä½¿ç”¨åœºæ™¯

æˆ‘ä»¬å…ˆæ˜ç¡®â€œä¸ºä»€ä¹ˆè¦åŒé”â€ï¼š

ä¾‹å¦‚ï¼Œä½ æœ‰ä¸¤ä¸ªå±‚çº§çš„èµ„æºï¼š

* ä¸€çº§é”ï¼šæ§åˆ¶å…¨å±€è®¿é—®ï¼ˆå¦‚æ•´ä¸ªä¸šåŠ¡æ¨¡å—ï¼‰
* äºŒçº§é”ï¼šæ§åˆ¶å…·ä½“ä¸šåŠ¡å®ä¾‹ï¼ˆå¦‚æŸä¸ªè®¢å•ã€æŸä¸ªå•†æˆ·ï¼‰

ä¾‹å¦‚ï¼š

```text
primaryKey = "biz:lock:merchant:123"
secondaryKey = "biz:lock:order:456"
```

å¸Œæœ›åšåˆ°ï¼š
1ï¸âƒ£ åŒä¸€å•†æˆ·ä¸‹çš„æ“ä½œä¸²è¡ŒåŒ–ï¼›
2ï¸âƒ£ åŒä¸€è®¢å•å†…çš„æ“ä½œä¹Ÿä¸²è¡ŒåŒ–ï¼›
3ï¸âƒ£ ä¸åŒå•†æˆ·é—´äº’ä¸å½±å“ã€‚

---

## ğŸ§  5.2ã€åŒé”çš„åŸºæœ¬å®ç°æ–¹å¼

Redisson çš„é”ä½¿ç”¨ `RLock` å®ç°ï¼Œå…¸å‹å†™æ³•å¦‚ä¸‹ï¼š

```java
RLock lock1 = redissonClient.getLock(primaryKey);
RLock lock2 = redissonClient.getLock(secondaryKey);

// å®šä¹‰ä¸€ä¸ªè”åˆé”ï¼ˆRedissonMultiLock ä¼šåŒæ—¶æŒæœ‰å¤šä¸ªé”ï¼‰
RLock multiLock = redissonClient.getMultiLock(lock1, lock2);

boolean locked = multiLock.tryLock(5, 10, TimeUnit.SECONDS);
try {
    if (locked) {
        // ä¸šåŠ¡é€»è¾‘
    }
} finally {
    if (locked) {
        multiLock.unlock();
    }
}
```

ğŸŸ¢ **è§£é‡Šï¼š**

* `tryLock(waitTime, leaseTime)`ï¼šç­‰å¾…æ—¶é—´ + æŒæœ‰æ—¶é—´ã€‚
* `RMultiLock` ä¼šåœ¨åº•å±‚é¡ºåºè·å–æ‰€æœ‰é”ï¼ˆé»˜è®¤æ˜¯é¡ºåºåŠ é”ï¼‰ã€‚
* æ‰€æœ‰é”éƒ½åŠ æˆåŠŸæ‰ç®—æˆåŠŸï¼Œå¦åˆ™ä¼šé‡Šæ”¾å·²åŠ çš„é”ã€‚

---

## âš ï¸ 5.3ã€åŒé”è®¾è®¡ä¸­æœ€å¸¸è§çš„æ­»é”åŸå› 

### âŒ 1. è·å–é¡ºåºä¸ä¸€è‡´

å‡è®¾çº¿ç¨‹Aå’Œçº¿ç¨‹Béƒ½éœ€è¦é”1å’Œé”2ï¼š

* Aï¼šå…ˆæ‹¿é”1 â†’ å†æ‹¿é”2ï¼›
* Bï¼šå…ˆæ‹¿é”2 â†’ å†æ‹¿é”1ï¼›
  â†’ æ­»é”ï¼

### âŒ 2. éƒ¨åˆ†é”åŠ æˆåŠŸä½†å¼‚å¸¸é€€å‡º

Redisson çš„ `multiLock` ä¼šå°è¯•åŠ å®Œæ‰€æœ‰é”ï¼Œä½†å¦‚æœä¸­é€”å‡ºå¼‚å¸¸ï¼ˆä¾‹å¦‚ Redis ç½‘ç»œé—ªæ–­ï¼‰ï¼Œå¯èƒ½ä¼šç•™ä¸‹éƒ¨åˆ†é”è¢«åŠ ä¸Šä½†æœªé‡Šæ”¾ã€‚

### âŒ 3. é”ç»­æœŸæ—¶é—´ä¸è¶³

å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…å‡º `leaseTime`ï¼Œè€Œæ²¡æœ‰ watchDog è‡ªåŠ¨ç»­æœŸï¼Œåˆ™é”å¯èƒ½è¿‡æ—©é‡Šæ”¾ï¼Œå¼•èµ·å¹¶å‘ä¿®æ”¹ã€‚

---

## âœ… 5.4ã€å®Œå…¨è§„é¿æ­»é”çš„è®¾è®¡æ–¹æ¡ˆ

ä¸‹é¢æ˜¯ä¸€ä¸ª**å¯ä»¥å®Œå…¨é¿å…æ­»é”**çš„æ¨èè®¾è®¡ï¼Œåˆ†ä¸ºä¸‰ç§æ–¹å¼ï¼š

---

### âœ… æ–¹æ¡ˆ1ï¼šå§‹ç»ˆä½¿ç”¨ `RMultiLock`ï¼ˆæ¨èï¼‰

**æ€è·¯ï¼š**
ç»Ÿä¸€é€šè¿‡ `RMultiLock` åŒæ—¶æŒæœ‰å¤šä¸ªé”ï¼Œè€Œä¸æ˜¯è‡ªå·±å…ˆå tryLockã€‚

```java
RLock lock1 = redissonClient.getLock(primaryKey);
RLock lock2 = redissonClient.getLock(secondaryKey);

// æ³¨æ„ï¼šRMultiLock å†…éƒ¨ä¸¥æ ¼ä¿è¯è·å–é¡ºåºç›¸åŒï¼Œé¿å…äº¤å‰æ­»é”
RLock multiLock = redissonClient.getMultiLock(lock1, lock2);

boolean locked = multiLock.tryLock(5, 30, TimeUnit.SECONDS);
try {
    if (locked) {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    } else {
        // æœªè·å–åˆ°é”ï¼Œå¯ç›´æ¥ä¸¢å¼ƒä»»åŠ¡æˆ–é‡è¯•
    }
} finally {
    if (locked) {
        multiLock.unlock();
    }
}
```

**ä¼˜ç‚¹ï¼š**

* åŠ é”ã€é‡Šæ”¾é”éƒ½åŸå­æ€§å¤„ç†ï¼›
* é¡ºåºä¸€è‡´ï¼›
* ä¸ä¼šå‡ºç°éƒ¨åˆ†åŠ é”çš„æƒ…å†µï¼›
* Redissonå†…éƒ¨è‡ªåŠ¨å¤„ç†ç»­æœŸï¼ˆwatchDogæœºåˆ¶ï¼‰ã€‚

**æ³¨æ„ï¼š**
`RMultiLock` çš„åŠ é”é€»è¾‘æ˜¯ä¸²è¡Œçš„ï¼Œå¦‚æœé”æ•°å¤šï¼ˆ>3ï¼‰ï¼ŒåŠ é”è€—æ—¶ä¼šç¨å¤§ã€‚

---

### âœ… æ–¹æ¡ˆ2ï¼šå¼ºåˆ¶é”é¡ºåº + è¶…æ—¶é‡Šæ”¾ï¼ˆé€‚ç”¨äºä¸ä½¿ç”¨MultiLockçš„æƒ…å†µï¼‰

å¦‚æœä½ åšæŒè¦åˆ†ä¸¤æ¬¡tryLockï¼ˆå› ä¸ºä¸šåŠ¡ä¸Šä¸ä¸€å®šä¸¤ä¸ªé”éƒ½æ€»æ˜¯éœ€è¦ï¼‰ï¼š

```java
RLock lock1 = redissonClient.getLock(primaryKey);
RLock lock2 = redissonClient.getLock(secondaryKey);

boolean locked1 = false;
boolean locked2 = false;

try {
    // å›ºå®šé¡ºåºï¼šå…ˆé”1å†é”2
    locked1 = lock1.tryLock(5, 30, TimeUnit.SECONDS);
    if (!locked1) return false;

    locked2 = lock2.tryLock(5, 30, TimeUnit.SECONDS);
    if (!locked2) return false;

    // ä¸šåŠ¡é€»è¾‘
} finally {
    if (locked2) lock2.unlock();
    if (locked1) lock1.unlock();
}
```

**é˜²æ­»é”å…³é”®ç‚¹ï¼š**

* æ°¸è¿œä¿è¯é”è·å–é¡ºåºä¸€è‡´ï¼ˆæ‰€æœ‰çº¿ç¨‹ä¸€è‡´ï¼ï¼‰ï¼›
* tryLock éƒ½æœ‰è¶…æ—¶ï¼›
* finally ä¸­ä¸¥æ ¼æŒ‰é€†åºé‡Šæ”¾ï¼›
* å‡ºç°ä»»ä¸€å¤±è´¥ç«‹å³é‡Šæ”¾å‰é¢é”ã€‚

---

### âœ… æ–¹æ¡ˆ3ï¼šé€»è¾‘åˆå¹¶ â†’ å•ä¸€å¤åˆé”Key

æœ‰æ—¶åŒé”å®Œå…¨æ²¡å¿…è¦ã€‚
å¯ä»¥é€šè¿‡ **ä¸šåŠ¡Keyæ‹¼æ¥**ï¼Œå½¢æˆä¸€ä¸ªå”¯ä¸€æ€§å¼ºçš„å•é”ï¼š

```java
String combinedKey = "biz:lock:" + merchantId + ":" + orderId;
RLock lock = redissonClient.getLock(combinedKey);
```

ä¼˜ç‚¹ï¼š

* é€»è¾‘ç®€å•ï¼›
* æ— æ­»é”é£é™©ï¼›
* æ€§èƒ½æœ€é«˜ã€‚

ç¼ºç‚¹ï¼š

* ç²’åº¦è¾ƒç²—ï¼›
* ä¸èƒ½å•ç‹¬æ§åˆ¶éƒ¨åˆ†é”ã€‚

---

## ğŸ§¯ 5.5ã€æ­»é”é˜²å¾¡ checklist

| é—®é¢˜    | é˜²å¾¡ç­–ç•¥                            |
| ----- | ------------------------------- |
| é”é¡ºåºä¸åŒ | æ‰€æœ‰åœ°æ–¹åŠ é”é¡ºåºå¿…é¡»ä¸€è‡´                    |
| æŸé”æœªé‡Šæ”¾ | try/finally ä¸¥æ ¼é‡Šæ”¾                |
| ç½‘ç»œé—ªæ–­  | ä½¿ç”¨ RedissonMultiLock            |
| åŠ é”å¤ªä¹…  | ä½¿ç”¨åˆç† leaseTime æˆ–å¯ç”¨ watchDog     |
| åŠ é”å¤±è´¥  | tryLock + è¶…æ—¶å‚æ•°ï¼Œä¸è¦ç”¨ lock() é˜»å¡å¼æ–¹æ³• |

---

## âœ… 5.6ã€æ¨èæ¨¡æ¿ä»£ç ï¼ˆç”Ÿäº§å¯ç”¨ï¼‰

```java
public boolean executeWithDoubleLock(String key1, String key2, Runnable task) {
    RLock lock1 = redissonClient.getLock(key1);
    RLock lock2 = redissonClient.getLock(key2);
    RLock multiLock = redissonClient.getMultiLock(lock1, lock2);

    boolean locked = false;
    try {
        locked = multiLock.tryLock(5, 30, TimeUnit.SECONDS);
        if (!locked) {
            log.warn("Double lock acquisition failed: {}, {}", key1, key2);
            return false;
        }
        task.run();
        return true;
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
        return false;
    } catch (Exception e) {
        log.error("Error during double lock execution", e);
        return false;
    } finally {
        if (locked) {
            try {
                multiLock.unlock();
            } catch (Exception e) {
                log.warn("Failed to unlock multiLock", e);
            }
        }
    }
}
```

---

## ğŸ”’5.7 ç»“è®ºæ€»ç»“

| åœºæ™¯        | æ¨èæ–¹æ¡ˆ            | æ­»é”é£é™©   |
| --------- | --------------- | ------ |
| ä¸¤ä¸ªé”å§‹ç»ˆæˆå¯¹å‡ºç° | âœ… `RMultiLock`  | ğŸš« æ— æ­»é” |
| ä¸¤ä¸ªé”å¯å•ç‹¬å­˜åœ¨  | âœ… å›ºå®šåŠ é”é¡ºåº + è¶…æ—¶é‡Šæ”¾ | âš ï¸ éœ€è°¨æ… |
| åŒé”é€»è¾‘å¯ä»¥ç®€åŒ–  | âœ… å•é”Keyæ‹¼æ¥       | ğŸš« æ— æ­»é” |

---

æ˜¯å¦æ–¹ä¾¿æˆ‘å¸®ä½ ç”»ä¸€ä¸ªå›¾æ¥å±•ç¤ºè¿™ä¸‰ç§æ–¹æ¡ˆçš„åŠ é”ä¸é‡Šæ”¾æµç¨‹ï¼Ÿå›¾å½¢åŒ–åä½ èƒ½ä¸€çœ¼çœ‹å‡ºä¸ºä»€ä¹ˆç¬¬ä¸€ç§ï¼ˆ`RMultiLock`ï¼‰æ˜¯æœ€ç¨³å¦¥çš„ã€‚


