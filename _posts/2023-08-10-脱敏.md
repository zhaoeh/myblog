---
layout:     post
title:      脱敏
subtitle:   熟悉spring web应用中的各种脱敏场景
categories: [零散知识点]
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---

# 1.什么是脱敏？
脱敏：就是将敏感信息脱离，即对于一些敏感信息，将其直接转换为某些隐藏字符去展示，从而实现敏感信息的脱离状态。   

# 2.为什么要脱敏？
上面说了，在一个系统中，凡是暴露给外部进行展示的信息，其中包含敏感信息的，都应该进行脱敏处理。比如用户的姓名、银行卡号、身份证号、手机号等信息，不能随意的暴露在日志中、操作系统的前台页面中、以及任何可以进行公开展示的组件中。   
因此，对于敏感信息，为了安全起见，就需要进行脱敏。这在软件安全设计中，尤为重要。   

# 3. spring boot构建的java web系统中如何实现脱敏？
首先，在一个应用系统中，要对哪些信息进行脱敏？即脱敏源是啥？如何脱敏？即脱敏策略是啥？这都是需要分析的。    
一般来讲，在java web系统中，脱敏源常见的有如下：   
在实际企业级 Java Web 系统中，**脱敏（Data Masking）** 的应用场景要更广一些。下面我给你系统梳理一份完整的清单：

---

## ✅ 一、常见脱敏场景分类

### **1️⃣ 日志输出（Logging 层）**

> ✅ 这是最容易泄露敏感信息的环节。

**典型问题：**

* 日志中打印了用户手机号、身份证、账号、Token 等。
* 异常堆栈中包含业务对象的 `toString()`，间接泄露隐私。

**常见解决方案：**

* AOP 切面对所有 `@Controller` 或 `@Service` 的方法入参和出参统一脱敏。
* 日志框架（如 logback、log4j2）中自定义 `PatternLayout` 或 `Converter`。
* 利用 MDC（Mapped Diagnostic Context）在特定上下文里动态脱敏。

---

### **2️⃣ API 接口响应（Response 层）**

> ✅ 用户前端看到的数据必须符合权限脱敏策略。

**典型问题：**

* 响应 JSON 中暴露了身份证、手机号、银行卡号等完整字段。
* 不同角色（管理员 vs 普通用户）看到的内容应不同。

**常见解决方案：**

* Jackson 自定义序列化器（你现在用的这一类）。
* `ResponseBodyAdvice` 统一处理返回体。
* 利用 MixIn 或 AOP 动态控制脱敏策略。

---

### **3️⃣ 数据库存储层（Persistence 层）**

> ✅ 有时候连 DBA 也不能看到真实数据。

**典型问题：**

* 用户表中直接存储明文手机号、身份证号。
* 运维导出数据库后数据泄露。

**常见解决方案：**

* **写入前加密 / 读取后解密**（例如 AES 对称加密）。
* MyBatis 拦截器、JPA AttributeConverter、或数据库原生函数（如 MySQL AES_ENCRYPT）。
* 分库分表时也需保持脱敏一致性。

---

### **4️⃣ 接口调用链（Feign / RPC / MQ）**

> ✅ 服务之间传输的数据也可能需要脱敏。

**典型问题：**

* 内部服务调用（Feign）时，传递的 DTO 中带敏感字段。
* 消息中间件（Kafka / RocketMQ）传输含敏感字段的消息。
* 甚至是 ES / Redis 中的缓存结构存了明文。

**常见解决方案：**

* 定义脱敏序列化器，确保序列化传输前脱敏。
* 对 MQ 消息体统一封装并脱敏。
* 在中台层（如网关 / BFF）做统一过滤。

---

### **5️⃣ 导出功能（Excel / CSV / PDF 等）**

> ✅ 业务导出时的敏感字段极容易被忽略。

**典型问题：**

* 用户导出 Excel 时，手机号、邮箱等暴露。
* 审计日志导出时带完整 IP 或 token。

**常见解决方案：**

* Excel 导出工具（如 EasyExcel、POI）加自定义 `Converter`。
* 导出前统一过脱敏策略（在 service 层）。

---

### **6️⃣ 外部系统集成（API 网关 / 日志平台 / 监控）**

> ✅ 外部系统对接时，日志或 tracing 数据会被同步。

**典型问题：**

* API 网关记录的完整请求响应包含敏感信息。
* 埋点日志（如 SkyWalking、Zipkin、Sentry）中带了用户隐私。

**常见解决方案：**

* 网关层定义通用的脱敏 Filter。
* 埋点 SDK 或拦截器中注册脱敏规则。
* 对请求体 / 响应体关键字段正则脱敏。

---

### **7️⃣ 配置文件与环境变量**

> ✅ 不属于业务数据，但同样敏感。

**典型问题：**

* application.yml 里存放明文数据库密码、第三方 API key。
* Spring Boot Actuator 暴露配置详情。

**常见解决方案：**

* 使用 Jasypt、KMS（密钥管理服务）加密配置。
* 禁用 actuator 的 `/env`、`/configprops` 暴露。
* 自定义 PropertySource 实现敏感项脱敏打印。

---

## ✅ 二、总结：一个企业级脱敏体系的层级结构

| 层级  | 场景                   | 脱敏策略                                 |
| --- | -------------------- | ------------------------------------ |
| 应用层 | 日志输出                 | AOP + 自定义 Logger Converter           |
| 接口层 | API 响应               | Jackson 自定义序列化器 / ResponseBodyAdvice |
| 数据层 | 数据库存储                | 加密存储 + ORM 拦截器                       |
| 通信层 | Feign / MQ / Redis   | 序列化前脱敏                               |
| 文件层 | Excel / PDF 导出       | Converter 层脱敏                        |
| 运维层 | 日志 / 链路追踪 / Actuator | 日志过滤 + 黑名单字段                         |

---

要不要我帮你画一张图，展示一下整个脱敏体系在 SpringBoot 架构中的分层关系？那张图能非常直观地看出每个环节脱敏该在哪一层做。

