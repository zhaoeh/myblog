---
layout:     post
title:      架构设计
subtitle:   一个好的架构设计案例
categories: [面试]
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---

# 1. 业务背景
**tachi企业级管理系统**
基于大数据团队和企业级管理，开发一款平台性质的管理系统。    
核心功能：   
- 提供B端用户和C端用户注册能力
- 提供用户认证授权能力
- 提供Saas多租户的数据隔离能力
- 提供通告广播的能力
- 提供实时通讯的能力
- 提供短信邮件的能力
- 提供支付退款能力
- 提供商城能力，B端企业和C端企业可以进行下单、付款等常规电商场景
- 提供文件上传和下载能力
- 提供操作日志记录能力
- 提供大数据报表渲染能力

# 2. 架构设计
分为几个微服务模块：   
- taich-gateway：网关服务，通过路由配置，不同的B端请求转发到B端服务，C端请求转发到C端服务，进行下游服务分发
- taich-user模块：统一管理B端和C端的用户注册、登录问题，以及使用spring security实现用户登录认证，并且提供restful接口供其他微服务调用，提供oauth2.0 jwt token的校验能力。
- taich-sms模块：统一进行短信发送，通过rabbitMQ、Kafka禁停其他服务广播的消息，从而触发短信发送事件
- taich-email：统一进行邮件发送，通过rabbitMQ、Kafka监听其他服务广播的消息，从而触发邮件发送事件
- taich-pay：统一进行支付服务，比如连接支付宝、微信支付接口进行钱包数据转移。提供两种方式：1.通过restful api实时暴露支付服务 2.通过监听kafka消息进行支付消息的消费。
- taich-store：自营商城，通过redis缓存下单消息并持久化到DB，通过rabbitMQ、Kafka广播支付消息、taich-pay进行支付消息监听，通过seata和手动的方式（可靠消息最终一致性）确保下单服务和支付服务的分布式事务一致性
- taich-discount：优惠服务，包括送积分、满减、会员充值等能力，于taich-store服务通过restful api和rabbitMQ、Kafka等方式进行消息通信，通过seata和手动的方式（可靠消息最终一致性）确保下单服务（下单送积分）和送积分服务的分布式事务一致性
- taich-product：产品服务，负责产品信息管理和库存管理，主要暴露给office端进行手动管理，以及提供给C端其他服务进行下单服务的锁定等。
- taich-msg:消息服务，主要用来负责消息的持久化、发送、以及xxlJob定时轮询兜底发送待发送消息，以及与各个业务侧的回查接口进行rpc通信。
- taich-file：文件服务，主要用来提供文件的上传落地与下载能力，技术实现细节支持以aws的s3协议扩展的亚马逊文件服务、minIO、阿里云、腾讯云、七牛云等文件云服务能力。

# 3. 技术实现细节
- 服务注册与发现：nacos
- 配置中心：nacos
- 网关：spring cloud gatwway，统一流量入口，结合Hystrix或者AOP策略进行限流。
- 下游服务：通过rabbitMQ、Kafka或者feign的方式与其他服务进行rpc交互，各个微服务可通过hystrix或者自定义aop+注解实现权限校验、限流、服务熔断与降级等策略。
- 消息广播：通过rabbitMQ、Kafka等广播下单消息、用户注册、登录消息等，达到服务之间的异步解耦。
- 事务：通过seata或者各个微服务手动控制事务（可靠消息最终一致性），通过消息服务的轮询兜底发送以及业务侧回查，实现分布式事务的最终一致性。以及MQ的重试机制，确保消息不丢失，以及业务侧实现幂等性逻辑。
- 数据库：使用分区表，或者分库分表策略，实现数据的定向路由，以及数据查询时的索引优化，入参查询范围限制等。
- 缓存：使用caffeine作为各自微服务的本地缓存，使用redis作为共享缓存，缓存热点数据比如热点商品、以及各种开关标志等，缓存用户token信息等。
- 商品搜索以及日志搜索：使用ES检索商品信息以及日志信息。
- 链路追踪：使用SkyWalking进行日志的全链路追踪，方便快速定位问题。
- 日志管理：使用ELK管理日志，实现日志的分布式采集、存储以及分析等。
- 性能监控：Grafana
